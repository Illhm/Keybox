name: KeyBox Checker

on:
  workflow_dispatch:
    inputs:
      keybox_url:
        description: "URL ke file KeyBox (XML)"
        required: true
        type: string
      revocations_url:
        description: "URL file JSON revocation (opsional)"
        required: false
        type: string

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install cryptography lxml

      - name: Download KeyBox XML
        env:
          KEYBOX_URL: ${{ inputs.keybox_url }}
        run: |
          set -euo pipefail
          curl -fsSL "$KEYBOX_URL" -o "keybox.xml"
          echo "KeyBox downloaded: keybox.xml (size: $(wc -c < keybox.xml) bytes)"

      - name: Download revocation list (optional)
        if: ${{ inputs.revocations_url }}
        env:
          REVOKE_URL: ${{ inputs.revocations_url }}
        run: |
          set -euo pipefail
          curl -fsSL "$REVOKE_URL" -o "revoked.json"
          echo "Revocations downloaded: revoked.json (size: $(wc -c < revoked.json) bytes)"

      - name: Run KeyBox Checker
        shell: bash
        run: |
          set -euo pipefail
          if [ -f revoked.json ]; then
            python validate_keybox.py keybox.xml --revocations revoked.json | tee report.txt
          else
            python validate_keybox.py keybox.xml | tee report.txt
          fi
          {
            echo "### KeyBox Checker Result"
            echo
            echo '```text'
            # Ringkasan paling relevan ke Job Summary
            grep -E "RESULT|LEAKED|VALID" report.txt | tail -n 100 || true
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: keybox-report
          path: |
            report.txt
            keybox.xml
            revoked.json
          if-no-files-found: ignore
